<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Kanban Board - Glass Theme</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #43508c 0%, #a9b9e2 100%);
    color: #e3e6e8; margin: 0; padding: 26px 0 0 0;
    max-width: 1180px; margin-left:auto; margin-right:auto;
  }
  h1 { margin: 0 0 18px 0; letter-spacing: 2px; font-weight: 800; text-shadow: 0 4px 24px #1a213a53;}
  .topbar-flex {
    display: flex; align-items: center; gap: 10px; margin: 0 0 10px 0;
    background: rgba(230,238,255,0.11); border-radius: 18px; padding: 8px 16px 6px 19px;
    box-shadow: 0 3px 30px rgba(50,70,140,0.13); backdrop-filter: blur(15px);
  }
  .topbar-flex button, .topbar-flex label {
    background: rgba(255,255,255,0.13); color: #283850;
    font-size: 0.97em; border: none; border-radius: 9px;
    padding: 6px 13px;
    cursor: pointer; transition: background 0.2s;
    font-weight: 600; margin-right: 2px;
    min-width: 0; line-height: 1.15;
  }
  .topbar-flex button:hover {
    background: rgba(45,65,130,0.25); color: #e3e6e8;
  }
  .topbar-flex input[type="search"] {
    border-radius: 8px; border: none; padding: 5px 9px;
    font-size: 0.98em; width: 116px; margin: 0 5px 0 0;
    background: #f4f7fb99;
    color: #205070; transition: background 0.14s;
  }
  .topbar-flex input[type="search"]:focus { background: #deeafd;}
  .hidden { display: none !important;}
  #addFormTodo {
    display: flex; flex-wrap: wrap; gap: 9px 16px; max-width: 470px;
    background: rgba(255,255,255,0.20);
    border-radius: 14px; box-shadow: 0 2px 22px rgba(43,54,120,0.07);
    padding: 13px 19px 12px 17px; margin: 12px 0 18px 18px;
    color: #24335a; backdrop-filter: blur(15px);
  }
  #addFormTodo label { flex: 0 0 204px; font-weight:600; font-size:0.98em;}
  #addFormTodo input, #addFormTodo select, #addFormTodo textarea {
    font-size: 0.97em; padding: 5.5px 8px; border-radius: 7px;
    border: none; margin-top: 2px; background: #eef3fa;
    color: #172850; width: 100%;
  }
  #addFormTodo textarea { min-height: 40px;}
  #addFormTodo .buttons-row { width: 100%; display: flex; gap: 12px; justify-content: flex-end; margin-top: 6px;}
  .kanban-container { display: flex; gap: 20px; min-height: 520px; margin-top: 5px;}
  .column {
    flex: 1 1 282px; min-width: 210px; max-width: 310px;
    background: rgba(255,255,255,0.24); border-radius: 16px;
    backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px);
    padding: 15px 7px 7px 7px; box-shadow: 0 8.5px 36px 0 rgba(65,82,140,0.22);
    margin: 0; display: flex; flex-direction: column;
  }
  .column h3 { text-align: center; font-weight: 700; font-size:1.10rem; letter-spacing:1.2px;}
  .task {
    background: rgba(255,255,255,0.17); border-radius: 11px;
    padding: 9px 15px 9px 13px; margin-bottom: 9px;
    border-left: 5px solid transparent; box-shadow: 0 2.5px 15px #4652822f;
    color: #f3f5f7; font-size: 0.98rem; word-break: break-word; position: relative;
    display: flex; flex-direction: column; gap: 4px;
  }
  .task:hover { box-shadow: 0 5px 25px #3d527640; }
  .priority-low { border-left-color: #43a047; }
  .priority-medium { border-left-color: #fb8c00; }
  .priority-major { border-left-color: #e53935; }
  .task .tags { color: #cfd8dc; font-size: 0.85rem;  margin-bottom: 2px;}
  .task .tags span {
    background: #e3eefd33; color:#294f6d;
    padding: 2px 8px; border-radius: 9px; margin-right: 4px; font-size: 0.90em;
  }
  .task .task-buttons { display: flex; justify-content: flex-end; gap: 7px; margin-top: 6px;}
  .task button {
    background: rgba(255,255,255,0.14); color: #1f3149; font-size: 0.78rem;
    padding: 4px 8px; border-radius: 7px; border: none;
  }
  .task button:hover { background: rgba(45,65,130,0.21); color: #e3e6e8;}
  .task-badge {
    position: absolute; top: 7px; right: 8px;
    font-size: 0.67rem; padding: 1.8px 7px; border-radius: 8px;
    background: #97ea9b; color: #248c44; font-weight: 600; user-select: none;
    text-transform: uppercase; letter-spacing: .07em; opacity: 0.95;
  }
  .badge-yesterday { background: #ffecbe; color: #c47d12;}
  .badge-old { background: #ffd1cf; color: #a6424e;}
  .more-detail-link {
    font-size:0.86em; color: #bddfff; cursor:pointer; text-decoration:underline; 
    margin:2px 0 0 0; display:inline-block; border:none; background:none; padding:0;
  }
  .history-details { font-size: 0.79em; color:#bed8e2; font-style:italic; margin:2px 0 4px 0; }
  /* Archive */
  #archiveSection {
    margin-top: 24px; background: rgba(255,255,255,0.19);
    backdrop-filter: blur(15px); color: #e3e6e8; border-radius: 14px; 
    box-shadow: 0 8px 29px #3e427034; padding: 16px 3vw 26px 3vw;
  }
  #archiveSection h2 { margin-bottom: 11px; }
  #archiveTasks .task { cursor: default; }
  /* Modal (Edit) */
  .modal-backdrop {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(34,55,92,0.14); display: flex;
    justify-content: center; align-items: center; z-index: 997;
  }
  .modal {
    background: rgba(245,250,255,0.25);
    border-radius: 14px; width: 340px; max-width: 94vw; max-height: 98vh; overflow-y: auto;
    padding: 17px 16px 15px 14px; color: #283847;
    box-shadow: 0 8px 30px #4a6b9a15; display: flex; flex-direction: column;
    backdrop-filter: blur(13px);
  }
  .modal-header { display: flex; justify-content: space-between; font-weight: 700; font-size: 1.08rem; margin-bottom: 10px; color: #213450;}
  .modal-close { cursor: pointer; font-size: 1.23rem; color: #596; border: none; background: none;}
  .modal-close:hover { color: #e53935; }
  .modal label { font-weight:600; font-size:0.95em; }
  .modal input, .modal select, .modal textarea {
    font-size: 1em; padding: 6px 9px; margin-top: 2px; background: #f7fafb;
    color: #172850; border-radius: 8px; border: none; width: 100%; margin-bottom: 6px;
  }
  .modal textarea { min-height: 32px;}
  .buttons-row { display: flex; justify-content: flex-end; gap: 10px; margin-top: 8px;}
  #importInput { display:none;}
</style>
</head>
<body>
<h1>Kanban Board</h1>
<div class="topbar-flex">
  <button id="showAddTodoTop" type="button">+ Add Task</button>
  <button id="backupBtn" type="button" title="Download tasks as JSON backup">Backup</button>
  <button id="restoreBtn" type="button" title="Import tasks from JSON file">Restore</button>
  <input type="file" id="importInput" accept="application/json" />
  <input type="search" id="searchInput" placeholder="Search..." aria-label="Search tasks..." />
</div>
<form id="addFormTodo" class="form-container hidden" aria-hidden="true" tabindex="-1" autocomplete="off">
  <label>Task Name<input type="text" id="todoName" required /></label>
  <label>Description<textarea id="todoDesc" spellcheck="true"></textarea></label>
  <label>Priority
    <select id="todoPriority">
      <option value="low">Low</option>
      <option value="medium" selected>Medium</option>
      <option value="major">Major</option>
    </select>
  </label>
  <label>Alarm Date & Time<input type="datetime-local" id="todoAlarm"/></label>
  <label>Tags (comma separated)<input type="text" id="todoTags" /></label>
  <div class="buttons-row">
    <button id="saveTodo" type="submit">Save</button>
    <button type="button" id="cancelTodo">Cancel</button>
  </div>
</form>
<div class="kanban-container" aria-label="Kanban board columns">
  <div class="column" id="todoCol"><h3>To-Do</h3><div id="todoTasks"></div></div>
  <div class="column" id="inprogressCol"><h3>In Progress</h3><div id="inprogressTasks"></div></div>
  <div class="column" id="doneCol"><h3>Done</h3><div id="doneTasks"></div></div>
</div>
<section id="archiveSection" class="hidden">
  <h2>Archive (tasks older than 7 days)</h2>
  <div id="archiveTasks"></div>
  <button id="closeArchive">Close Archive</button>
</section>
<button id="showArchiveBtn" aria-expanded="false" aria-controls="archiveSection" style="margin-top: 16px;">Show Archive</button>
<!-- Edit Modal -->
<div id="editModalBackdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" tabindex="-1">
  <div class="modal">
    <div class="modal-header">
      <div>Edit Task</div>
      <button id="closeEditModal" class="modal-close" type="button">&times;</button>
    </div>
    <form id="editTaskForm" autocomplete="off">
      <label>Task Name<input type="text" id="editName" required /></label>
      <label>Description<textarea id="editDesc" spellcheck="true"></textarea></label>
      <label>Priority
        <select id="editPriority">
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="major">Major</option>
        </select>
      </label>
      <label>Alarm Date & Time<input type="datetime-local" id="editAlarm"/></label>
      <label>Tags (comma separated)<input type="text" id="editTags"/></label>
      <label>Status
        <select id="editStatus">
          <option value="todo">To-Do</option>
          <option value="inprogress">In Progress</option>
          <option value="done">Done</option>
        </select>
      </label>
      <div class="buttons-row">
        <button type="submit">Save</button>
        <button type="button" id="cancelEdit">Cancel</button>
      </div>
    </form>
  </div>
</div>
<script>
let tasks = JSON.parse(localStorage.getItem("kanbanTasks") || "[]");
const todoTasksDiv = document.getElementById("todoTasks"), inprogressTasksDiv = document.getElementById("inprogressTasks"), doneTasksDiv = document.getElementById("doneTasks"), archiveTasksDiv = document.getElementById("archiveTasks"), archiveSection = document.getElementById("archiveSection"), showAddTodoTop = document.getElementById("showAddTodoTop"), addFormTodo = document.getElementById("addFormTodo"), saveTodoBtn = document.getElementById("saveTodo"), cancelTodoBtn = document.getElementById("cancelTodo"), searchInput = document.getElementById("searchInput"), showArchiveBtn = document.getElementById("showArchiveBtn"), closeArchiveBtn = document.getElementById("closeArchive"), backupBtn = document.getElementById("backupBtn"), restoreBtn = document.getElementById("restoreBtn"), importInput = document.getElementById("importInput"), editModalBackdrop = document.getElementById("editModalBackdrop"), closeEditModalBtn = document.getElementById("closeEditModal"), editTaskForm = document.getElementById("editTaskForm"), editNameInput = document.getElementById("editName"), editDescInput = document.getElementById("editDesc"), editPrioritySelect = document.getElementById("editPriority"), editAlarmInput = document.getElementById("editAlarm"), editTagsInput = document.getElementById("editTags"), editStatusSelect = document.getElementById("editStatus");
const PRIORITY_CLASSES = { low: "priority-low", medium: "priority-medium", major: "priority-major" };
function saveTasks() { localStorage.setItem("kanbanTasks", JSON.stringify(tasks)); }
function escapeHtml(text) { if (!text) return ""; return text.replace(/[&<>"']/g, m => ({ '&': "&amp;", '<': "&lt;", '>': "&gt;", '"': "&quot;", "'": "&#39;" })[m]); }
function getTaskAgeBadge(createdAt) { const created = new Date(createdAt), today = new Date(), yesterday = new Date(); yesterday.setDate(today.getDate() - 1); if (created.toDateString() === today.toDateString()) return 'Today'; if (created.toDateString() === yesterday.toDateString()) return 'Yesterday'; return null; }
function getTaskAgeClass(createdAt) { const created = new Date(createdAt), today = new Date(), yesterday = new Date(); yesterday.setDate(today.getDate() - 1); if (created.toDateString() === today.toDateString()) return 'badge-today'; if (created.toDateString() === yesterday.toDateString()) return 'badge-yesterday'; return 'badge-old'; }
function formatDateTime(ts) { return (new Date(ts)).toLocaleString(undefined, {dateStyle:'short',timeStyle:'short'});}
function renderTasks(container, taskArray, allowEditing = true, showHistory = false) {
  container.innerHTML = "";
  taskArray.forEach(task => {
    const div = document.createElement("div");
    div.className = "task " + PRIORITY_CLASSES[task.priority];
    div.draggable = allowEditing; div.dataset.id = task.id; div.tabIndex = 0;
    const ageBadge = getTaskAgeBadge(task.createdAt), ageClass = getTaskAgeClass(task.createdAt);
    const tagsHtml = task.tags && task.tags.length ? task.tags.map(tag => `<span>${escapeHtml(tag)}</span>`).join("") : "";
    const alarmStr = task.alarmDate ? formatDateTime(task.alarmDate) : "";
    div.innerHTML = `
      <div class="task-badge ${ageClass}">${ageBadge || ''}</div>
      <strong>${escapeHtml(task.name)}</strong>
      <details><summary>Description</summary><p>${escapeHtml(task.description || "No description")}</p></details>
      <div><b>Priority:</b> ${task.priority}</div>
      <div class="tags">${tagsHtml}</div>
      ${alarmStr ? `<div><b>Alarm:</b> ${alarmStr}</div>` : ""}
      <button class="more-detail-link" type="button">More details</button>
      <div class="history-details hidden">
        Created: ${formatDateTime(task.createdAt)}<br/>
        Edited: ${formatDateTime(task.updatedAt)}<br/>
        Moved: ${task.lastMovedAt ? formatDateTime(task.lastMovedAt) : 'N/A'}
      </div>
      ${allowEditing ? `<div class="task-buttons"><button class="editBtn">Edit</button><button class="deleteBtn">Delete</button></div>` : ""}
    `;
    container.appendChild(div);
    if (allowEditing) {
      div.addEventListener("dragstart", dragStart);
      div.querySelector(".editBtn").addEventListener("click", () => openEditModal(task.id));
      div.querySelector(".deleteBtn").addEventListener("click", () => deleteTask(task.id));
    }
    // "More details" toggler
    div.querySelector(".more-detail-link").addEventListener("click", function(){
      let hd = div.querySelector(".history-details");
      if (hd.classList.contains("hidden")) { hd.classList.remove("hidden"); this.textContent = "Hide details"; }
      else { hd.classList.add("hidden"); this.textContent = "More details"; }
    });
  });
}
function renderBoard() {
  const now = Date.now(), sevenDaysAgo = now - 7 * 24 * 60 * 60 * 1000, filtered = filterTasks(searchInput.value);
  const activeTasks = filtered.filter(t => new Date(t.createdAt).getTime() > sevenDaysAgo);
  const archivedTasks = filtered.filter(t => new Date(t.createdAt).getTime() <= sevenDaysAgo);
  renderTasks(todoTasksDiv, activeTasks.filter(t => t.status === "todo"));
  renderTasks(inprogressTasksDiv, activeTasks.filter(t => t.status === "inprogress"));
  renderTasks(doneTasksDiv, activeTasks.filter(t => t.status === "done"));
  renderTasks(archiveTasksDiv, archivedTasks, false);
}
function filterTasks(term) {
  term = term.trim().toLowerCase();
  if (!term) return tasks;
  return tasks.filter(t =>
    t.name.toLowerCase().includes(term) ||
    (t.description && t.description.toLowerCase().includes(term)) ||
    (t.tags && t.tags.some(tag => tag.toLowerCase().includes(term)))
  );
}

// Add form events
showAddTodoTop.addEventListener("click", () => {
  addFormTodo.classList.remove("hidden");
  addFormTodo.setAttribute("aria-hidden", "false");
  addFormTodo.querySelector("#todoName").focus();
});
cancelTodoBtn.addEventListener("click", () => {
  addFormTodo.classList.add("hidden"); addFormTodo.setAttribute("aria-hidden", "true"); clearAddForm();
});
function clearAddForm(){
  document.getElementById("todoName").value = "";
  document.getElementById("todoDesc").value = "";
  document.getElementById("todoPriority").value = "medium";
  document.getElementById("todoAlarm").value = "";
  document.getElementById("todoTags").value = "";
}
addFormTodo.addEventListener("submit", function(e){
  e.preventDefault();
  const name = document.getElementById("todoName").value.trim();
  if (!name) return alert("Task name is required");
  const desc = document.getElementById("todoDesc").value.trim(),
    priority = document.getElementById("todoPriority").value,
    alarmDate = document.getElementById("todoAlarm").value,
    tags = document.getElementById("todoTags").value.split(",").map(t => t.trim()).filter(Boolean);
  tasks.push({
    id: Date.now().toString() + Math.random().toString(36).slice(2),
    name, description: desc, priority,
    alarmDate: alarmDate ? new Date(alarmDate).toISOString() : null,
    tags, status: "todo",
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    lastMovedAt: null
  });
  saveTasks(); renderBoard(); clearAddForm();
  addFormTodo.classList.add("hidden"); addFormTodo.setAttribute("aria-hidden", "true");
});

// Drag and drop
let draggedTaskId = null;
function dragStart(event) {
  draggedTaskId = event.target.dataset.id;
  event.dataTransfer.setData("text/plain", draggedTaskId);
  event.dataTransfer.effectAllowed = "move";
}
function dragOver(event) { event.preventDefault(); }
function drop(event) {
  event.preventDefault();
  const columnId = event.currentTarget.id;
  if (!draggedTaskId) return;
  const task = tasks.find(t => t.id === draggedTaskId);
  if (task) {
    if (columnId === "todoCol") task.status = "todo";
    else if (columnId === "inprogressCol") task.status = "inprogress";
    else if (columnId === "doneCol") task.status = "done";
    task.lastMovedAt = new Date().toISOString();
    task.updatedAt = task.lastMovedAt;
    saveTasks(); renderBoard();
  }
  draggedTaskId = null;
}
["todoCol","inprogressCol","doneCol"].forEach(id=>{
  const col = document.getElementById(id);
  col.addEventListener("dragover", dragOver); col.addEventListener("drop", drop);
});
function deleteTask(id) {
  if (!confirm("Are you sure you want to delete this task?")) return;
  tasks = tasks.filter(t => t.id !== id); saveTasks(); renderBoard();
}
// Edit modal
let editingTaskId = null;
function openEditModal(id) {
  editingTaskId = id;
  const task = tasks.find(t => t.id === id);
  if (!task) return alert("Task not found");
  editNameInput.value = task.name;
  editDescInput.value = task.description || "";
  editPrioritySelect.value = task.priority;
  editAlarmInput.value = task.alarmDate ? task.alarmDate.substring(0,16) : "";
  editTagsInput.value = task.tags.join(", ");
  editStatusSelect.value = task.status;
  editModalBackdrop.classList.remove("hidden");
  setTimeout(() => { editNameInput.focus(); }, 120);
}
function closeEditModal() { editingTaskId = null; editModalBackdrop.classList.add("hidden"); }
closeEditModalBtn.addEventListener("click", closeEditModal);
document.getElementById("cancelEdit").addEventListener("click", closeEditModal);
editModalBackdrop.addEventListener("mousedown", function(e) { if (e.target === this) closeEditModal(); });
document.addEventListener("keydown", function(e) { if (e.key === "Escape" && !editModalBackdrop.classList.contains("hidden")) closeEditModal(); });
editTaskForm.addEventListener("submit", (e) => {
  e.preventDefault();
  if (!editingTaskId) return;
  const task = tasks.find(t => t.id === editingTaskId);
  if (!task) return alert("Task not found");
  const name = editNameInput.value.trim();
  if (!name) return alert("Task name is required");
  task.name = name;
  task.description = editDescInput.value.trim();
  task.priority = editPrioritySelect.value;
  task.alarmDate = editAlarmInput.value ? new Date(editAlarmInput.value).toISOString() : null;
  task.tags = editTagsInput.value.split(",").map(t => t.trim()).filter(Boolean);
  task.status = editStatusSelect.value;
  task.updatedAt = new Date().toISOString();
  saveTasks(); renderBoard(); closeEditModal();
});
showArchiveBtn.addEventListener("click", () => {
  archiveSection.classList.remove("hidden");
  document.querySelector(".kanban-container").classList.add("hidden");
  showArchiveBtn.setAttribute("aria-expanded", "true");
  showArchiveBtn.classList.add("hidden");
});
closeArchiveBtn.addEventListener("click", () => {
  archiveSection.classList.add("hidden");
  document.querySelector(".kanban-container").classList.remove("hidden");
  showArchiveBtn.setAttribute("aria-expanded", "false");
  showArchiveBtn.classList.remove("hidden");
});
searchInput.addEventListener("input", renderBoard);
// Alarm notifications
function requestNotifications() {
  if ("Notification" in window) {
    if (Notification.permission !== "granted" && Notification.permission !== "denied") Notification.requestPermission();
  }
}
requestNotifications();
function showAlarm(title, body) {
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification(title, { body: body });
  }
}
function notifyDueTasks() {
  if (!("Notification" in window) || Notification.permission !== "granted") return;
  const now = Date.now(), next30min = now + 30 * 60 * 1000;
  tasks.forEach(task => {
    if ((task.status === "todo" || task.status === "inprogress") && task.alarmDate) {
      const alarmTime = new Date(task.alarmDate).getTime();
      if (alarmTime <= next30min && alarmTime >= now - 5 * 60 * 1000) {
        showAlarm("Kanban Task Alarm", `${task.name} is due at ${new Date(task.alarmDate).toLocaleTimeString()}`);
      }
    }
  });
}
setInterval(() => { saveTasks(); }, 4 * 60 * 60 * 1000);
setInterval(() => { notifyDueTasks(); }, 30 * 60 * 1000);
// Backup/restore
backupBtn.addEventListener("click", () => {
  const dataStr = JSON.stringify(tasks, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `kanban-backup-${new Date().toISOString().substring(0,10)}.json`;
  a.click(); URL.revokeObjectURL(url);
});
restoreBtn.addEventListener("click", () => importInput.click());
importInput.addEventListener("change", (event) => {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (Array.isArray(imported)) {
        tasks = imported; saveTasks(); renderBoard();
        alert("Tasks restored successfully!");
      } else alert("Invalid file format.");
    } catch (error) { alert("Error reading file: " + error.message);}
  };
  reader.readAsText(file);
  importInput.value = "";
});
renderBoard();
</script>
</body>
</html>
