<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Kanban Board – Private, Glass, Modern</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #43508c 0%, #a9b9e2 100%); color: #e3e6e8; margin: 0; padding: 24px 0 0 0; max-width: 1120px; margin-left:auto; margin-right:auto;}
#privacyBadge {
  position: absolute;
  left: 30px;
  top: 18px;
  display: inline-flex;
  align-items: center;
  background: rgba(30,70,90,0.16);
  color: #b6e5fc;
  font-weight: 700;
  font-size: 0.97em;
  border-radius: 999px;
  padding: 3px 13px 3px 7px;
  box-shadow: 0 1.5px 10px #254d743c;
  z-index: 1002;
  transition: box-shadow .19s;
  cursor: pointer;
  outline: none;
  line-height: 1;
  min-width: 0;
  user-select:none;
}
#privacyBadge:hover, #privacyBadge:focus { box-shadow: 0 4px 20px #254d7457; }
#privacyBadge span { color: #6fd0fa; font-weight:800; font-size:1em;}
#privacyTooltip {
  position: absolute;
  left: 0;
  top: 33px;
  background: rgba(31,37,62,0.98);
  color: #e8f9ff;
  border-radius: 10px;
  box-shadow: 0 7px 40px #0007, 0 1px 7px #2260ab22;
  padding: 14px 15px 13px 13px;
  font-size: 0.97em;
  max-width: 340px;
  min-width: 220px;
  opacity: 1; pointer-events: auto;
  z-index: 1002;
  animation: tooltip-in .18s cubic-bezier(0.62,0,0.2,1);
}
@keyframes tooltip-in { from { opacity: 0; transform: translateY(-8px);} to { opacity:1;transform:none;}}
#privacyTooltip b { color: #98daff; }
#privacyTooltip.hidden { display: none; }
h1 { margin: 22px 0 15px 0; letter-spacing: 2px; font-weight: 800; text-shadow: 0 4px 18px #1a213a53; padding-left: 18px;}
.topbar-flex { display: flex; align-items: center; gap: 6px; margin: 0 0 14px 0; padding: 10px 14px 8px 18px; background: rgba(225, 235, 255, 0.15); border-radius: 18px; box-shadow: 0 2px 21px rgba(50,70,140,0.13); backdrop-filter: blur(13px); flex-wrap: wrap;}
.topbar-flex button { background: rgba(255,255,255,0.15); color: #24385e; font-size: 0.96em; border: none; border-radius: 8px; padding: 5.5px 13.5px; cursor: pointer; transition: background 0.18s; font-weight: 700; position: relative; min-width: 0; line-height: 1.15;}
.shortcut { font-size:0.83em; color:#183158; background: #abd9f5; font-weight:800; letter-spacing: .5px; margin-left: 4px; margin-right:0; padding: 1.2px 6px; border-radius:5px; outline: 1.2px solid #436a97; box-shadow: 0 1.5px 6px #202e4c1c; opacity:.92; vertical-align:middle; pointer-events:none; user-select:none;}
.topbar-flex input[type="search"] { border-radius: 7px; border: none; padding: 5px 12px; font-size: 0.96em; width: 110px; margin: 0 2px 0 1.5px; background: #f4f7fdad; color: #205070; }
.topbar-flex input[type="file"] { display:none;}
#addFormTodo { display: flex; flex-wrap: wrap; gap: 10px 17px; max-width: 420px; background: rgba(255,255,255,0.20); border-radius: 14px; box-shadow: 0 2px 22px rgba(43,54,120,0.07); padding: 12px 17px 10px 15px; margin: 13px 0 16px 18px; color: #24335a; backdrop-filter: blur(14px);}
#addFormTodo label { flex: 0 0 170px; font-weight:600; font-size:0.98em;}
#addFormTodo input, #addFormTodo select, #addFormTodo textarea { font-size: 0.96em; padding: 5px 8px; border-radius: 7px; border: none; margin-top: 2px; background: #eef3fa; color: #172850; width: 100%;}
#addFormTodo textarea { min-height: 38px;}
#addFormTodo .buttons-row { width: 100%; display: flex; gap: 11px; justify-content: flex-end; margin-top: 4px;}
.hidden { display: none !important;}
.kanban-container { display: flex; gap: 10px; min-height: 480px; margin-top: 5px; justify-content: center;}
.column { flex: 1 1 230px; min-width: 180px; max-width: 320px; background: rgba(255,255,255,0.20); border-radius: 15px; backdrop-filter: blur(19px); -webkit-backdrop-filter: blur(19px); padding: 14px 6px 7px 7px; margin: 0; display: flex; flex-direction: column; box-shadow: 0 7px 30px 0 rgba(62,82,130,0.16);}
.column h3 { text-align: center; font-weight: 700; font-size: 1.09rem; letter-spacing:1.06px;}
.task { background: rgba(255,255,255,0.15); border-radius: 10px; padding: 8px 11px 7px 11px; margin-bottom: 8px; border-left: 4px solid transparent; box-shadow: 0 2.5px 13px #5469a62c; color: #f3f5f7; font-size: 0.98rem; word-break: break-word; position: relative; display: flex; flex-direction: column; gap: 3px;}
.task:hover { box-shadow: 0 5px 17px #3d527640; }
.priority-low { border-left-color: #43a047; }
.priority-medium { border-left-color: #fb8c00; }
.priority-major { border-left-color: #e53935; }
.task .tags { color: #cfd8dc; font-size: 0.81rem;}
.task .tags span { background: #e3eefd33; color:#294f6d; padding: 2px 8px; border-radius: 8px; margin-right: 3px; font-size: 0.90em;}
.task .task-buttons { display: flex; justify-content: flex-end; gap: 7px; margin-top: 2.5px;}
.task button { background: rgba(255,255,255,0.14); color: #1f3149; font-size: 0.77rem; padding: 3px 7px; border-radius: 6px; border: none;}
.task button:hover { background: rgba(65,90,140,0.20); color: #e3e6e8;}
.task-badge { position: absolute; top: 7px; right: 8px; font-size: 0.67rem; padding: 1.7px 7px; border-radius: 8px; background: #97ea9b; color: #248c44; font-weight: 600; user-select: none; text-transform: uppercase; letter-spacing: .07em; opacity: 0.95;}
.badge-yesterday { background: #ffecbe; color: #c47d12;}
.badge-old { background: #ffd1cf; color: #a6424e;}
.more-detail-link { font-size:0.88em; color: #bddfff; cursor:pointer; text-decoration:underline; margin:2px 0 0 0; display:inline-block; border:none; background:none; padding:0;}
.history-details { font-size: 0.78em; color:#bed8e2; font-style:italic; margin:2px 0 4px 0; }
#archiveSection { margin-top: 20px; background: rgba(255,255,255,0.14); backdrop-filter: blur(13px); color: #e3e6e8; border-radius: 12px; box-shadow: 0 6px 22px #3e427033; padding: 14px 2vw 17px 2vw;}
#archiveSection h2 { margin-bottom: 9px; }
#archiveTasks .task { cursor: default; }
.modal-backdrop { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(34,55,92,0.13); display: flex; justify-content: center; align-items: center; z-index: 997;}
.modal { background: rgba(245,250,255,0.24); border-radius: 10px; width: 320px; max-width: 94vw; max-height: 97vh; overflow-y: auto; padding: 15px 13px 13px 13px; color: #283847; box-shadow: 0 8px 25px #4a6b9a16; display: flex; flex-direction: column; backdrop-filter: blur(10px);}
.modal-header { display: flex; justify-content: space-between; font-weight: 700; font-size: 1.07rem; margin-bottom: 9px; color: #213450; align-items: center;}
.modal-close { cursor: pointer; font-size: 1.14rem; color: #596; border: none; background: none;font-weight:900; margin-left:9px; margin-top:0;}
.modal-close:hover { color: #e53935; }
.modal label { font-weight:600; font-size:0.94em;}
.modal input, .modal select, .modal textarea { font-size: 1em; padding: 6px 7px; margin-top: 2px; background: #f8fafc; color: #172850; border-radius: 7px; border: none; width: 100%; margin-bottom: 5px;}
.modal textarea { min-height: 29px;}
.buttons-row { display: flex; justify-content: flex-end; gap: 8px; margin-top: 5px;}
</style>
</head>
<body>
<div id="privacyBadge" tabindex="0" aria-label="Privacy Info">
  <svg width="16" height="16" viewBox="0 0 20 20" style="vertical-align:-3px;margin-right:5px;"><circle cx="10" cy="10" r="9" fill="#6fd0fa"/><text x="10" y="16" text-anchor="middle" font-size="15" font-weight="bold" fill="#1a354d">i</text></svg>
  <span>Privacy</span>
  <div id="privacyTooltip" class="hidden">
    <b>Data Privacy Notice:</b>
    <br/>All your Kanban board data is <b>only stored locally in your browser.</b><br/>
    We do <b>not</b> store, backup, sync, or collect any data—your board is <b>private and personal</b>.<br/>
    <b>Backup regularly</b> so you never lose your tasks.
  </div>
</div>
<h1>Kanban Board</h1>
<div class="topbar-flex">
  <button id="showAddTodoTop" type="button" aria-label="Add (Alt+A)">+ Add Task <span class="shortcut">Alt+A</span></button>
  <button id="backupBtn" type="button" aria-label="Backup (Alt+B)">Backup <span class="shortcut">Alt+B</span></button>
  <button id="restoreBtn" type="button" aria-label="Restore (Alt+R)">Restore <span class="shortcut">Alt+R</span></button>
  <button id="showArchiveBtn" type="button" aria-label="Show Archive (Alt+V)">Archive <span class="shortcut">Alt+V</span></button>
  <input type="file" id="importInput" accept="application/json" />
  <input type="search" id="searchInput" placeholder="Search..." aria-label="Search tasks..." title="Alt+F or / to focus" />
</div>
<form id="addFormTodo" class="form-container hidden" aria-hidden="true" tabindex="-1" autocomplete="off">
  <label>Task Name<input type="text" id="todoName" required /></label>
  <label>Description<textarea id="todoDesc" spellcheck="true"></textarea></label>
  <label>Priority
    <select id="todoPriority">
      <option value="low">Low</option>
      <option value="medium" selected>Medium</option>
      <option value="major">Major</option>
    </select>
  </label>
  <label>Alarm Date & Time<input type="datetime-local" id="todoAlarm"/></label>
  <label>Tags (comma separated)<input type="text" id="todoTags" /></label>
  <div class="buttons-row">
    <button id="saveTodo" type="submit"><u>S</u>ave <span class="shortcut">Alt+S</span></button>
    <button type="button" id="cancelTodo"><u>C</u>ancel <span class="shortcut">Alt+C</span></button>
  </div>
</form>
<div class="kanban-container" aria-label="Kanban board columns">
  <div class="column" id="todoCol"><h3>To-Do</h3><div id="todoTasks"></div></div>
  <div class="column" id="inprogressCol"><h3>In Progress</h3><div id="inprogressTasks"></div></div>
  <div class="column" id="doneCol"><h3>Done</h3><div id="doneTasks"></div></div>
</div>
<section id="archiveSection" class="hidden">
  <h2>Archive (tasks older than 7 days)</h2>
  <div id="archiveTasks"></div>
  <button id="closeArchive"><u>X</u> Close <span class="shortcut">Alt+X / Esc</span></button>
</section>
<div id="editModalBackdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" tabindex="-1">
  <div class="modal">
    <div class="modal-header">
      <div>Edit Task</div>
      <button id="closeEditModal" class="modal-close" type="button" title="Close">&times;</button>
    </div>
    <form id="editTaskForm" autocomplete="off">
      <label>Task Name<input type="text" id="editName" required /></label>
      <label>Description<textarea id="editDesc" spellcheck="true"></textarea></label>
      <label>Priority
        <select id="editPriority">
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="major">Major</option>
        </select>
      </label>
      <label>Alarm Date & Time<input type="datetime-local" id="editAlarm"/></label>
      <label>Tags (comma separated)<input type="text" id="editTags"/></label>
      <label>Status
        <select id="editStatus">
          <option value="todo">To-Do</option>
          <option value="inprogress">In Progress</option>
          <option value="done">Done</option>
        </select>
      </label>
      <div class="buttons-row">
        <button type="submit"><u>S</u>ave <span class="shortcut">Alt+S</span></button>
        <button type="button" id="cancelEdit"><u>C</u>ancel <span class="shortcut">Alt+C / Esc</span></button>
      </div>
    </form>
  </div>
</div>
<script>
const privacy=document.getElementById('privacyBadge');
const tooltip=document.getElementById('privacyTooltip');
privacy.addEventListener('mouseenter', ()=>{ tooltip.classList.remove('hidden'); });
privacy.addEventListener('mouseleave', ()=>{ tooltip.classList.add('hidden'); });
privacy.addEventListener('focus', ()=>{ tooltip.classList.remove('hidden'); });
privacy.addEventListener('blur', ()=>{ tooltip.classList.add('hidden'); });
privacy.addEventListener('click', ()=>{ tooltip.classList.toggle('hidden'); });

let tasks = JSON.parse(localStorage.getItem("kanbanTasks") || "[]");
const todoTasksDiv = document.getElementById("todoTasks"),
  inprogressTasksDiv = document.getElementById("inprogressTasks"),
  doneTasksDiv = document.getElementById("doneTasks"),
  archiveTasksDiv = document.getElementById("archiveTasks"),
  archiveSection = document.getElementById("archiveSection"),
  showAddTodoTop = document.getElementById("showAddTodoTop"),
  addFormTodo = document.getElementById("addFormTodo"),
  saveTodoBtn = document.getElementById("saveTodo"),
  cancelTodoBtn = document.getElementById("cancelTodo"),
  searchInput = document.getElementById("searchInput"),
  showArchiveBtn = document.getElementById("showArchiveBtn"),
  closeArchiveBtn = document.getElementById("closeArchive"),
  backupBtn = document.getElementById("backupBtn"),
  restoreBtn = document.getElementById("restoreBtn"),
  importInput = document.getElementById("importInput"),
  editModalBackdrop = document.getElementById("editModalBackdrop"),
  closeEditModalBtn = document.getElementById("closeEditModal"),
  editTaskForm = document.getElementById("editTaskForm"),
  editNameInput = document.getElementById("editName"),
  editDescInput = document.getElementById("editDesc"),
  editPrioritySelect = document.getElementById("editPriority"),
  editAlarmInput = document.getElementById("editAlarm"),
  editTagsInput = document.getElementById("editTags"),
  editStatusSelect = document.getElementById("editStatus");
const PRIORITY_CLASSES = { low: "priority-low", medium: "priority-medium", major: "priority-major" };
let editingTaskId = null;
function saveTasks() { localStorage.setItem("kanbanTasks", JSON.stringify(tasks)); }
function escapeHtml(text) { if (!text) return ""; return text.replace(/[&<>"']/g, m => ({ '&': "&amp;", '<': "&lt;", '>': "&gt;", '"': "&quot;", "'": "&#39;" })[m]); }
function getTaskAgeBadge(createdAt) { const created = new Date(createdAt), today = new Date(), yesterday = new Date(); yesterday.setDate(today.getDate() - 1); if (created.toDateString() === today.toDateString()) return 'Today'; if (created.toDateString() === yesterday.toDateString()) return 'Yesterday'; return null; }
function getTaskAgeClass(createdAt) { const created = new Date(createdAt), today = new Date(), yesterday = new Date(); yesterday.setDate(today.getDate() - 1); if (created.toDateString() === today.toDateString()) return 'badge-today'; if (created.toDateString() === yesterday.toDateString()) return 'badge-yesterday'; return 'badge-old'; }
function formatDateTime(ts) { return (new Date(ts)).toLocaleString(undefined, {dateStyle:'short',timeStyle:'short'});}
function renderTasks(container, taskArray, allowEditing = true) {
  container.innerHTML = "";
  taskArray.forEach(task => {
    const div = document.createElement("div");
    div.className = "task " + PRIORITY_CLASSES[task.priority];
    div.draggable = allowEditing; div.dataset.id = task.id; div.tabIndex = 0;
    const ageBadge = getTaskAgeBadge(task.createdAt), ageClass = getTaskAgeClass(task.createdAt);
    const tagsHtml = task.tags && task.tags.length ? task.tags.map(tag => `<span>${escapeHtml(tag)}</span>`).join("") : "";
    const alarmStr = task.alarmDate ? formatDateTime(task.alarmDate) : "";
    div.innerHTML = `
      <div class="task-badge ${ageClass}">${ageBadge || ''}</div>
      <strong>${escapeHtml(task.name)}</strong>
      <details><summary>Description</summary><p>${escapeHtml(task.description || "No description")}</p></details>
      <div><b>Priority:</b> ${task.priority}</div>
      <div class="tags">${tagsHtml}</div>
      ${alarmStr ? `<div><b>Alarm:</b> ${alarmStr}</div>` : ""}
      <button class="more-detail-link" type="button">More details</button>
      <div class="history-details hidden">
        Created: ${formatDateTime(task.createdAt)}<br/>
        Edited: ${formatDateTime(task.updatedAt)}<br/>
        Moved: ${task.lastMovedAt ? formatDateTime(task.lastMovedAt) : 'N/A'}
      </div>
      ${allowEditing ? `<div class="task-buttons"><button class="editBtn">Edit</button><button class="deleteBtn">Delete</button></div>` : ""}
    `;
    container.appendChild(div);
    if (allowEditing) {
      div.addEventListener("dragstart", dragStart);
      div.querySelector(".editBtn").addEventListener("click", () => openEditModal(task.id));
      div.querySelector(".deleteBtn").addEventListener("click", () => deleteTask(task.id));
    }
    div.querySelector(".more-detail-link").addEventListener("click", function(){
      let hd = div.querySelector(".history-details");
      if (hd.classList.contains("hidden")) { hd.classList.remove("hidden"); this.textContent = "Hide details"; }
      else { hd.classList.add("hidden"); this.textContent = "More details"; }
    });
  });
}
function renderBoard() {
  const now = Date.now(), sevenDaysAgo = now - 7 * 24 * 60 * 60 * 1000, filtered = filterTasks(searchInput.value);
  const activeTasks = filtered.filter(t => new Date(t.createdAt).getTime() > sevenDaysAgo);
  const archivedTasks = filtered.filter(t => new Date(t.createdAt).getTime() <= sevenDaysAgo);
  renderTasks(todoTasksDiv, activeTasks.filter(t => t.status === "todo"));
  renderTasks(inprogressTasksDiv, activeTasks.filter(t => t.status === "inprogress"));
  renderTasks(doneTasksDiv, activeTasks.filter(t => t.status === "done"));
  renderTasks(archiveTasksDiv, archivedTasks, false);
}
function filterTasks(term) {
  term = term.trim().toLowerCase();
  if (!term) return tasks;
  return tasks.filter(t =>
    t.name.toLowerCase().includes(term) ||
    (t.description && t.description.toLowerCase().includes(term)) ||
    (t.tags && t.tags.some(tag => tag.toLowerCase().includes(term)))
  );
}
// Add form events
showAddTodoTop.addEventListener("click", () => {
  addFormTodo.classList.remove("hidden");
  addFormTodo.setAttribute("aria-hidden", "false");
  addFormTodo.querySelector("#todoName").focus();
});
cancelTodoBtn.addEventListener("click", () => {
  addFormTodo.classList.add("hidden"); addFormTodo.setAttribute("aria-hidden", "true"); clearAddForm();
});
function clearAddForm(){
  document.getElementById("todoName").value = "";
  document.getElementById("todoDesc").value = "";
  document.getElementById("todoPriority").value = "medium";
  document.getElementById("todoAlarm").value = "";
  document.getElementById("todoTags").value = "";
}
addFormTodo.addEventListener("submit", function(e){
  e.preventDefault();
  const name = document.getElementById("todoName").value.trim();
  if (!name) return alert("Task name is required");
  const desc = document.getElementById("todoDesc").value.trim(),
    priority = document.getElementById("todoPriority").value,
    alarmDate = document.getElementById("todoAlarm").value,
    tags = document.getElementById("todoTags").value.split(",").map(t => t.trim()).filter(Boolean);
  tasks.push({
    id: Date.now().toString() + Math.random().toString(36).slice(2),
    name, description: desc, priority,
    alarmDate: alarmDate ? new Date(alarmDate).toISOString() : null,
    tags, status: "todo",
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    lastMovedAt: null
  });
  saveTasks(); renderBoard(); clearAddForm();
  addFormTodo.classList.add("hidden"); addFormTodo.setAttribute("aria-hidden", "true");
});
// Drag and drop
let draggedTaskId = null;
function dragStart(event) {
  draggedTaskId = event.target.dataset.id;
  event.dataTransfer.setData("text/plain", draggedTaskId);
  event.dataTransfer.effectAllowed = "move";
}
function dragOver(event) { event.preventDefault(); }
function drop(event) {
  event.preventDefault();
  const columnId = event.currentTarget.id;
  if (!draggedTaskId) return;
  const task = tasks.find(t => t.id === draggedTaskId);
  if (task) {
    if (columnId === "todoCol") task.status = "todo";
    else if (columnId === "inprogressCol") task.status = "inprogress";
    else if (columnId === "doneCol") task.status = "done";
    task.lastMovedAt = new Date().toISOString();
    task.updatedAt = task.lastMovedAt;
    saveTasks(); renderBoard();
  }
  draggedTaskId = null;
}
["todoCol","inprogressCol","doneCol"].forEach(id=>{
  const col = document.getElementById(id);
  col.addEventListener("dragover", dragOver); col.addEventListener("drop", drop);
});
function deleteTask(id) {
  if (!confirm("Are you sure you want to delete this task?")) return;
  tasks = tasks.filter(t => t.id !== id); saveTasks(); renderBoard();
}
// Edit modal
function openEditModal(id) {
  editingTaskId = id;
  const task = tasks.find(t => t.id === id);
  if (!task) return alert("Task not found");
  editNameInput.value = task.name;
  editDescInput.value = task.description || "";
  editPrioritySelect.value = task.priority;
  editAlarmInput.value = task.alarmDate ? task.alarmDate.substring(0,16) : "";
  editTagsInput.value = task.tags.join(", ");
  editStatusSelect.value = task.status;
  editModalBackdrop.classList.add("hidden");
  setTimeout(() => {editModalBackdrop.classList.remove("hidden");editNameInput.focus();},10);
}
function closeEditModal() {
  editingTaskId = null;
  editModalBackdrop.classList.add("hidden");
}
closeEditModalBtn.addEventListener("click", closeEditModal);
document.getElementById("cancelEdit").addEventListener("click", closeEditModal);
editModalBackdrop.addEventListener("mousedown", function(e) { if (e.target === this) closeEditModal(); });
document.addEventListener("keydown", function(e) {
  if (e.key === "Escape" && !editModalBackdrop.classList.contains("hidden")) closeEditModal();
});
editTaskForm.addEventListener("submit", (e) => {
  e.preventDefault();
  if (!editingTaskId) return;
  const task = tasks.find(t => t.id === editingTaskId);
  if (!task) return alert("Task not found");
  const name = editNameInput.value.trim();
  if (!name) return alert("Task name is required");
  task.name = name;
  task.description = editDescInput.value.trim();
  task.priority = editPrioritySelect.value;
  task.alarmDate = editAlarmInput.value ? new Date(editAlarmInput.value).toISOString() : null;
  task.tags = editTagsInput.value.split(",").map(t => t.trim()).filter(Boolean);
  task.status = editStatusSelect.value;
  task.updatedAt = new Date().toISOString();
  saveTasks(); renderBoard(); closeEditModal();
});
showArchiveBtn.addEventListener("click", () => {
  archiveSection.classList.remove("hidden");
  document.querySelector(".kanban-container").classList.add("hidden");
  showArchiveBtn.setAttribute("aria-expanded", "true");
  showArchiveBtn.classList.add("hidden");
  closeArchiveBtn.focus();
});
closeArchiveBtn.addEventListener("click", closeArchiveSection);
function closeArchiveSection() {
  archiveSection.classList.add("hidden");
  document.querySelector(".kanban-container").classList.remove("hidden");
  showArchiveBtn.setAttribute("aria-expanded", "false");
  showArchiveBtn.classList.remove("hidden");
  showArchiveBtn.focus();
}
searchInput.addEventListener("input", renderBoard);
// Alarm notifications
function requestNotifications() {
  if ("Notification" in window) {
    if (Notification.permission !== "granted" && Notification.permission !== "denied") Notification.requestPermission();
  }
}
requestNotifications();
function showAlarm(title, body) {
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification(title, { body: body });
  }
}
function notifyDueTasks() {
  if (!("Notification" in window) || Notification.permission !== "granted") return;
  const now = Date.now(), next30min = now + 30 * 60 * 1000;
  tasks.forEach(task => {
    if ((task.status === "todo" || task.status === "inprogress") && task.alarmDate) {
      const alarmTime = new Date(task.alarmDate).getTime();
      if (alarmTime <= next30min && alarmTime >= now - 5 * 60 * 1000) {
        showAlarm("Kanban Task Alarm", `${task.name} is due at ${new Date(task.alarmDate).toLocaleTimeString()}`);
      }
    }
  });
}
setInterval(() => { saveTasks(); }, 4 * 60 * 60 * 1000);
setInterval(() => { notifyDueTasks(); }, 30 * 60 * 1000);
// Backup/restore
backupBtn.addEventListener("click", () => {
  const dataStr = JSON.stringify(tasks, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `kanban-backup-${new Date().toISOString().substring(0,10)}.json`;
  a.click(); URL.revokeObjectURL(url);
});
restoreBtn.addEventListener("click", () => importInput.click());
importInput.addEventListener("change", (event) => {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (Array.isArray(imported)) {
        tasks = imported; saveTasks(); renderBoard();
        alert("Tasks restored successfully!");
      } else alert("Invalid file format.");
    } catch (error) { alert("Error reading file: " + error.message);}
  };
  reader.readAsText(file);
  importInput.value = "";
});
document.addEventListener("keydown", function(e){
  // Shortcuts: Alt + (A,B,R,F,V,S,C,X), or "/" for search
  const mod = e.altKey;
  if(document.activeElement.tagName.match(/^INPUT|TEXTAREA|SELECT$/i)) {
    // Save ("Alt+S") or Cancel ("Alt+C", "Escape") when Add/Edit modal is open
    if (addFormTodo && !addFormTodo.classList.contains('hidden')) {
      if (mod && e.key.toLowerCase() === "s") { saveTodoBtn.click(); e.preventDefault(); }
      else if ((mod && e.key.toLowerCase() === "c") || e.key === "Escape") { cancelTodoBtn.click(); e.preventDefault(); }
    }
    if (editModalBackdrop && !editModalBackdrop.classList.contains('hidden')) {
      if (mod && e.key.toLowerCase() === "s") { editTaskForm.querySelector('button[type="submit"]').click(); e.preventDefault(); }
      else if ((mod && e.key.toLowerCase() === "c") || e.key === "Escape") { closeEditModal(); e.preventDefault(); }
    }
    // "/" focuses search if not already in search
    if (e.key === "/" && document.activeElement !== searchInput) {
      searchInput.focus(); e.preventDefault();
    }
    return;
  }
  // Outside inputs (main navigation)
  if      (mod && e.key.toLowerCase() === "a") { showAddTodoTop.click(); e.preventDefault(); }
  else if (mod && e.key.toLowerCase() === "b") { backupBtn.click(); e.preventDefault(); }
  else if (mod && e.key.toLowerCase() === "r") { restoreBtn.click(); e.preventDefault(); }
  else if ((mod && e.key.toLowerCase() === "f") || e.key === "/") { searchInput.focus(); e.preventDefault(); }
  else if (mod && e.key.toLowerCase() === "v") { showArchiveBtn.click(); e.preventDefault(); }
  else if (mod && e.key.toLowerCase() === "x") { 
    if (!archiveSection.classList.contains('hidden')) { closeArchiveSection(); e.preventDefault(); }
  }
  // Escape always closes Add Task form, Archive, or Edit
  if (e.key === "Escape") {
    if (!addFormTodo.classList.contains('hidden')) cancelTodoBtn.click();
    if (!archiveSection.classList.contains('hidden')) closeArchiveSection();
    if (!editModalBackdrop.classList.contains('hidden')) closeEditModal();
  }
});
renderBoard();
</script>
</body>
</html>
